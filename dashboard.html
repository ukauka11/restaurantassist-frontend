<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RestaurantAssist • Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css">
  <style>
    .hero {
      margin-top: 18px;
      padding: 22px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      background:
        radial-gradient(1200px 420px at 10% 0%, rgba(56,189,248,0.18), transparent 55%),
        radial-gradient(900px 380px at 90% 10%, rgba(34,197,94,0.16), transparent 55%),
        #0b1224;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .hero h1{ margin:0; font-size: 34px; letter-spacing:-0.3px; color:#fff; }
    .hero .sub{ margin-top:10px; font-size:14px; color:#cbd5e1; line-height:1.6; max-width: 980px; }

    .grid { margin-top: 16px; display:grid; gap:16px; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 900px){ .row2{ grid-template-columns: 1fr; } }

    .sectionTitle{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .sectionTitle h2{ margin:0; font-size: 18px; color:#e2e8f0; }
    .hint{ font-size: 12px; color:#94a3b8; line-height: 1.5; }

    label{ display:block; font-size: 13px; color:#94a3b8; margin: 10px 0 6px; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: #0a1020;
      color:#e5e7eb;
      outline:none;
    }
    textarea{ min-height: 120px; resize: vertical; }
    input:focus, select:focus, textarea:focus{ border-color: rgba(56,189,248,0.8); }

    .actions{ margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px; border-radius: 999px;
      font-weight: 800; font-size: 12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color:#cbd5e1;
    }
    .pill.ok{ border-color: rgba(34,197,94,0.35); background: rgba(34,197,94,0.10); color:#bbf7d0; }
    .pill.warn{ border-color: rgba(251,191,36,0.35); background: rgba(251,191,36,0.10); color:#fde68a; }
    .pill.bad{ border-color: rgba(248,113,113,0.35); background: rgba(248,113,113,0.10); color:#fecaca; }

    pre.code{
      margin: 10px 0 0 0;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      background: #070b16;
      color:#cbd5e1;
      overflow:auto;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(2,6,23,0.85);
      color:#e5e7eb;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      font-weight: 800;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
    }
    .toast.show{ opacity: 1; }

    details.advanced {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      border-radius: 16px;
      padding: 14px 16px;
    }
    details.advanced > summary{
      cursor: pointer;
      list-style: none;
      font-weight: 900;
      color:#e2e8f0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    details.advanced > summary::-webkit-details-marker{ display:none; }
    .tiny{ font-size: 12px; color:#94a3b8; }

    code{ background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 6px; }
    a{ color:#7dd3fc; }
  </style>
</head>

<body>
  <div class="container">

    <!-- NAV -->
    <div class="nav">
      <div class="brand"><div class="dot"></div><span>RestaurantAssist</span></div>
      <div class="navlinks">
        <a class="btn" href="/">Home</a>
        <a class="btn" href="/dashboard.html">Dashboard</a>
        <a class="btn" href="/docs.html">Docs</a>
        <a class="btn" href="/support.html">Support</a>
      </div>
    </div>

    <!-- HERO / SUPER SIMPLE INSTRUCTIONS -->
    <div class="hero">
      <h1>Dashboard</h1>
      <div class="sub">
        <strong>3 easy steps:</strong>
        1) Paste your API key (from your email) •
        2) Click <strong>Load my account</strong> •
        3) Paste a review and click <strong>Generate response</strong>.
      </div>
    </div>

    <div class="grid">

      <!-- CONNECT + ACCOUNT -->
      <div class="card">
        <div class="sectionTitle">
          <h2>1) Connect</h2>
          <div id="statusPill" class="pill">Not connected</div>
        </div>

        <div class="row2">
          <div>
            <label>API Base URL</label>
            <input id="apiBase" value="https://review-assistant-api.onrender.com" />
            <div class="hint" style="margin-top:8px;">
              Tip: Leave this alone unless we tell you to change it.
            </div>
          </div>
          <div>
            <label>Your API Key (<code>x-api-key</code>)</label>
            <input id="apiKey" placeholder="cust_..." />
            <div class="hint" style="margin-top:8px;">
              We email this after checkout. If it lands in Spam, click “Not spam”.
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="loadBtn">Load my account</button>
          <button class="btn" id="saveBtn">Save key locally</button>
          <button class="btn" id="clearBtn">Clear saved key</button>
          <button class="btn" id="copyKeyBtn">Copy API key</button>
        </div>

        <div class="row2" style="margin-top: 12px;">
          <div>
            <div class="sectionTitle" style="margin-bottom:6px;">
              <h2 style="font-size:16px;">2) Account</h2>
              <div class="tiny">from <code>/me</code></div>
            </div>

            <div class="hint">Business:</div>
            <div id="bizOut" style="font-weight:900; margin-top:4px;">—</div>

            <div class="hint" style="margin-top:10px;">Email:</div>
            <div id="emailOut" style="font-weight:900; margin-top:4px;">—</div>
          </div>

          <div>
            <div class="hint">Plan:</div>
            <div id="planOut" style="font-weight:900; margin-top:4px;">—</div>

            <div class="hint" style="margin-top:10px;">Status:</div>
            <div id="subOut" style="font-weight:900; margin-top:4px;">—</div>

            <div class="hint" style="margin-top:10px;">Renews / ends:</div>
            <div id="renewOut" style="font-weight:900; margin-top:4px;">—</div>

            <div class="hint" style="margin-top:10px;">
              If your status is <strong>past_due</strong> or <strong>canceled</strong>, requests will return <code>402</code>.
            </div>
          </div>
        </div>

        <div id="msg" class="hint" style="margin-top:12px;"></div>
      </div>

      <!-- GENERATE RESPONSE (THE MAIN FEATURE) -->
      <div class="card">
        <div class="sectionTitle">
          <h2>3) Generate a response</h2>
          <div class="pill">Paste review → Generate → Copy</div>
        </div>

        <div class="row2">
          <div>
            <label>Platform</label>
            <select id="platform">
              <option value="google">Google</option>
              <option value="yelp">Yelp</option>
              <option value="facebook">Facebook</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label>Optional: Customer name</label>
            <input id="customerName" placeholder="(optional)" />
          </div>
        </div>

        <div class="row2">
          <div>
            <label>Optional: Order number</label>
            <input id="orderNumber" placeholder="(optional)" />
          </div>
          <div>
            <label>Optional: Run ID</label>
            <input id="runId" placeholder="(optional)" />
          </div>
        </div>

        <label>Paste the customer review</label>
        <textarea id="reviewText" placeholder="Example: Food was great but the wait was long..."></textarea>

        <div class="actions">
          <button class="btn" id="genBtn">Generate response</button>
          <button class="btn" id="copyReplyBtn" disabled>Copy reply</button>
          <button class="btn" id="copyJsonBtn" disabled>Copy full result</button>
        </div>

        <div id="genMsg" class="hint" style="margin-top:10px;"></div>

        <div style="margin-top:12px;">
          <div class="hint">Ready-to-post reply:</div>
          <pre class="code" id="replyOut">—</pre>
        </div>

        <div style="margin-top:12px;">
          <div class="hint">Full result (tags, sentiment, urgency, etc.):</div>
          <pre class="code" id="jsonOut">—</pre>
        </div>
      </div>

      <!-- ADVANCED (Docs style / curl / troubleshooting) -->
      <details class="advanced">
        <summary>
          <span>Advanced (optional)</span>
          <span class="tiny">curl + raw API examples</span>
        </summary>

        <div style="margin-top: 12px;">
          <div class="sectionTitle">
            <h2>Copy-paste curl examples</h2>
            <div class="hint">For developers / IT help</div>
          </div>

          <div class="actions">
            <button class="btn" id="copyMeBtn">Copy /me curl</button>
            <button class="btn" id="copyAnalyzeBtn">Copy /analyze curl</button>
            <button class="btn" id="copySummaryBtn">Copy /summary curl</button>
            <a class="btn" href="/docs.html" style="text-decoration:none;">Open full Docs</a>
          </div>

          <pre class="code" id="curlOut">Paste your API key above to generate curl commands.</pre>
        </div>
      </details>

    </div>

    <div class="footer">
      © <span id="yr"></span> RestaurantAssist • Questions? <a href="/support.html">Support</a>
    </div>
  </div>

  <div id="toast" class="toast">Copied!</div>

  <script>
    document.getElementById("yr").textContent = new Date().getFullYear();

    const apiBaseEl = document.getElementById("apiBase");
    const apiKeyEl = document.getElementById("apiKey");

    const statusPill = document.getElementById("statusPill");
    const msgEl = document.getElementById("msg");

    const bizOut = document.getElementById("bizOut");
    const emailOut = document.getElementById("emailOut");
    const planOut = document.getElementById("planOut");
    const subOut = document.getElementById("subOut");
    const renewOut = document.getElementById("renewOut");

    const genBtn = document.getElementById("genBtn");
    const genMsg = document.getElementById("genMsg");
    const replyOut = document.getElementById("replyOut");
    const jsonOut = document.getElementById("jsonOut");
    const copyReplyBtn = document.getElementById("copyReplyBtn");
    const copyJsonBtn = document.getElementById("copyJsonBtn");

    const curlOut = document.getElementById("curlOut");

    const toastEl = document.getElementById("toast");
    function toast(text="Copied!"){
      toastEl.textContent = text;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 900);
    }

    function baseUrl(){
      return apiBaseEl.value.trim().replace(/\/+$/, "");
    }
    function apiKey(){
      return apiKeyEl.value.trim();
    }

    function setPill(state, text){
      statusPill.className = "pill";
      if (state === "ok") statusPill.classList.add("ok");
      if (state === "warn") statusPill.classList.add("warn");
      if (state === "bad") statusPill.classList.add("bad");
      statusPill.textContent = text;
    }

    function buildCurl(){
      const base = baseUrl();
      const key = apiKey();
      if (!key){
        curlOut.textContent = "Paste your API key above to generate curl commands.";
        return;
      }

      curlOut.textContent =
`/me
curl "${base}/me" \\
  -H "x-api-key: ${key}"

---

/analyze
curl -X POST "${base}/analyze" \\
  -H "Content-Type: application/json" \\
  -H "x-api-key: ${key}" \\
  -d "{\\"review_text\\":\\"The food was great but the wait was long\\", \\"platform\\":\\"google\\"}"

---

/summary
curl "${base}/summary" \\
  -H "x-api-key: ${key}"`;
    }

    // Load saved key from localStorage
    const saved = localStorage.getItem("ra_api_key");
    if (saved) apiKeyEl.value = saved;

    buildCurl();

    apiBaseEl.addEventListener("input", buildCurl);
    apiKeyEl.addEventListener("input", () => { buildCurl(); setPill("", "Not connected"); });

    document.getElementById("saveBtn").addEventListener("click", () => {
      const key = apiKey();
      if (!key) return;
      localStorage.setItem("ra_api_key", key);
      toast("Saved locally");
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      localStorage.removeItem("ra_api_key");
      apiKeyEl.value = "";
      buildCurl();
      setPill("", "Not connected");
      toast("Cleared");
    });

    document.getElementById("copyKeyBtn").addEventListener("click", async () => {
      const key = apiKey();
      if (!key) return;
      await navigator.clipboard.writeText(key);
      toast("API key copied");
    });

    // Load account via /me
    document.getElementById("loadBtn").addEventListener("click", async () => {
      msgEl.textContent = "";
      const key = apiKey();
      if (!key){
        msgEl.textContent = "Paste your API key first (starts with cust_...).";
        setPill("warn", "Missing key");
        return;
      }

      setPill("warn", "Connecting…");
      msgEl.textContent = "Loading your account…";

      try{
        const res = await fetch(`${baseUrl()}/me`, {
          headers: { "x-api-key": key }
        });

        const data = await res.json().catch(()=> ({}));

        if (!res.ok){
          const detail = data?.detail || `Error ${res.status}`;
          msgEl.textContent = detail;

          if (res.status === 401) setPill("bad", "Unauthorized (bad key)");
          else if (res.status === 402) setPill("bad", "Subscription inactive");
          else setPill("bad", "Error");

          return;
        }

        const sub = data.subscription || {};
        bizOut.textContent = data.business_id || "—";
        emailOut.textContent = data.email || "—";
        planOut.textContent = sub.plan || "starter";
        subOut.textContent = sub.status || "inactive";
        renewOut.textContent = sub.current_period_end || "N/A";

        if (sub.status === "active"){
          setPill("ok", "Connected (active)");
        } else if (sub.status === "past_due"){
          setPill("warn", "Connected (past due)");
        } else {
          setPill("bad", "Connected (inactive)");
        }

        msgEl.textContent = "Account loaded.";

      } catch (e){
        setPill("bad", "Network error");
        msgEl.textContent = "Network error. Check your API Base URL and internet.";
      }
    });

    // Generate response via /analyze
    genBtn.addEventListener("click", async () => {
      genMsg.textContent = "";
      replyOut.textContent = "—";
      jsonOut.textContent = "—";
      copyReplyBtn.disabled = true;
      copyJsonBtn.disabled = true;

      const key = apiKey();
      if (!key){
        genMsg.textContent = "Paste your API key first.";
        return;
      }

      const review_text = document.getElementById("reviewText").value.trim();
      const platform = document.getElementById("platform").value;
      const customer_name = document.getElementById("customerName").value.trim();
      const order_number = document.getElementById("orderNumber").value.trim();
      const run_id = document.getElementById("runId").value.trim();

      if (!review_text){
        genMsg.textContent = "Paste the customer review first.";
        return;
      }

      genMsg.textContent = "Generating… (takes a few seconds)";
      genBtn.disabled = true;

      try{
        const res = await fetch(`${baseUrl()}/analyze`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": key
          },
          body: JSON.stringify({
            review_text,
            platform,
            customer_name,
            order_number,
            run_id: run_id || null
          })
        });

        const data = await res.json().catch(()=> ({}));

        if (!res.ok){
          const detail = data?.detail || `Error ${res.status}`;
          genMsg.textContent = detail;

          if (res.status === 401) setPill("bad", "Unauthorized (bad key)");
          if (res.status === 402) setPill("bad", "Subscription inactive");
          return;
        }

        const record = data.record || {};
        const reply = record.reply || "(No reply returned)";

        replyOut.textContent = reply;
        jsonOut.textContent = JSON.stringify(data, null, 2);

        copyReplyBtn.disabled = false;
        copyJsonBtn.disabled = false;

        genMsg.textContent = "Done. Copy and paste your reply into Google/Yelp/Facebook.";

      } catch (e){
        genMsg.textContent = "Network error. Please try again.";
      } finally {
        genBtn.disabled = false;
      }
    });

    copyReplyBtn.addEventListener("click", async () => {
      const txt = replyOut.textContent.trim();
      if (!txt || txt === "—") return;
      await navigator.clipboard.writeText(txt);
      toast("Reply copied");
    });

    copyJsonBtn.addEventListener("click", async () => {
      const txt = jsonOut.textContent.trim();
      if (!txt || txt === "—") return;
      await navigator.clipboard.writeText(txt);
      toast("Full result copied");
    });

    // Advanced curl copy buttons
    document.getElementById("copyMeBtn").addEventListener("click", async () => {
      if (curlOut.textContent.includes("Paste your API key")) return;
      const base = baseUrl(); const key = apiKey();
      const t = `curl "${base}/me" \\\n  -H "x-api-key: ${key}"`;
      await navigator.clipboard.writeText(t);
      toast("/me curl copied");
    });

    document.getElementById("copyAnalyzeBtn").addEventListener("click", async () => {
      if (curlOut.textContent.includes("Paste your API key")) return;
      const base = baseUrl(); const key = apiKey();
      const t =
`curl -X POST "${base}/analyze" \\
  -H "Content-Type: application/json" \\
  -H "x-api-key: ${key}" \\
  -d "{\\"review_text\\":\\"The food was great but the wait was long\\", \\"platform\\":\\"google\\"}"`;
      await navigator.clipboard.writeText(t);
      toast("/analyze curl copied");
    });

    document.getElementById("copySummaryBtn").addEventListener("click", async () => {
      if (curlOut.textContent.includes("Paste your API key")) return;
      const base = baseUrl(); const key = apiKey();
      const t = `curl "${base}/summary" \\\n  -H "x-api-key: ${key}"`;
      await navigator.clipboard.writeText(t);
      toast("/summary curl copied");
    });
  </script>
</body>
</html>


