<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RestaurantAssist — Dashboard</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand"><div class="dot"></div><span>RestaurantAssist</span></div>
      <div class="navlinks">
        <a class="btn" href="/">Home</a>
        <a class="btn" href="/dashboard.html">Dashboard</a>
        <a class="btn" href="/docs.html">Docs</a>
        <a class="btn" href="mailto:support@restaurantassist.app">Support</a>
      </div>
    </div>
    <div class="wrap">
      <div class="card">
        <h1>RestaurantAssist Dashboard</h1>
        <p class="muted">Paste your API key to view your subscription status and get ready-to-use examples.</p>
      </div>
  
      <div class="card">
        <h2>1) Connect</h2>
        <div class="row">
          <div>
            <label for="apiBase">API Base URL</label>
            <input id="apiBase" value="https://review-assistant-api.onrender.com" />
            <div class="small" style="margin-top:6px;">
              Tip: If you later set up <code>api.restaurantassist.app</code>, update this value.
            </div>
          </div>
          <div>
            <label for="apiKey">Your API Key (x-api-key)</label>
            <input id="apiKey" placeholder="cust_..." />
            <div class="small" style="margin-top:6px;">
              We emailed this to you after checkout. If you didn’t get it, check Spam and click “Not spam”.
            </div>
          </div>
        </div>
  
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="btnLoad">Load my account</button>
          <button class="btn" id="btnSave">Save key locally</button>
          <button class="btn" id="btnClear">Clear saved key</button>
          <button class="btn" id="btnCopyKey">Copy API key</button>
          <span class="pill" id="statusPill">Not connected</span>
        </div>
  
        <div id="err" class="small bad" style="margin-top:10px; display:none;"></div>
      </div>
  
      <div class="card">
        <h2>2) Account</h2>
        <div class="row">
          <div>
            <p><strong>Business:</strong> <span id="biz">—</span></p>
            <p><strong>Email:</strong> <span id="email">—</span></p>
          </div>
          <div>
            <p><strong>Plan:</strong> <span id="plan">—</span></p>
            <p><strong>Status:</strong> <span id="subStatus">—</span></p>
            <p><strong>Renews / ends:</strong> <span id="periodEnd">—</span></p>
          </div>
        </div>
        <div class="small">
          If your status is <strong>past_due</strong> or <strong>canceled</strong>, API requests will return <code>402</code>.
        </div>
      </div>
  
      <div class="card">
        <h2>3) Quick start</h2>
        <p>Try these from Terminal / Command Prompt (replace review text):</p>
        <div class="copyrow">
          <button class="btn" id="btnCopyAnalyze">Copy /analyze curl</button>
          <span class="copyhint">Paste into Terminal / Command Prompt</span>
        </div>
        <pre id="curlAnalyze"></pre>
        
        <div class="copyrow">
          <button class="btn" id="btnCopySummary">Copy /summary curl</button>
          <span class="copyhint">Paste into Terminal / Command Prompt</span>
        </div>
        <pre id="curlSummary"></pre>
  
        <div style="margin-top:10px;">
          <a class="btn" href="/" >Back to home</a>
        </div>
      </div>
  
      <div class="card">
        <h2>Help</h2>
        <ul class="small">
          <li><strong>Email went to Spam?</strong> Open it and click <strong>“Not spam”</strong> to train Gmail.</li>
          <li><strong>Lost your API key?</strong> Email <a href="mailto:support@restaurantassist.app">support@restaurantassist.app</a> and we’ll reset it.</li>
          <li><strong>API returns 401?</strong> Make sure you pasted the full <code>cust_...</code> key and saved it.</li>
          <li><strong>API returns 402?</strong> Your subscription is not active (past_due/canceled).</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function showErr(msg){
      const el = $("err");
      el.style.display = msg ? "block" : "none";
      el.textContent = msg || "";
    }

    function setPill(text, ok){
      const p = $("statusPill");
      p.textContent = text;
      p.classList.remove("ok","bad");
      if (ok === true) p.classList.add("ok");
      if (ok === false) p.classList.add("bad");
    }

    function getBase(){
      return $("apiBase").value.trim().replace(/\/+$/,"");
    }
    function getKey(){
      return $("apiKey").value.trim();
    }

    function updateCurlExamples(){
      const base = getBase() || "https://review-assistant-api.onrender.com";
      const key = getKey() || "cust_YOUR_KEY_HERE";

      $("curlAnalyze").textContent =
`curl -X POST "${base}/analyze" \\
  -H "Content-Type: application/json" \\
  -H "x-api-key: ${key}" \\
  -d "{\\"review_text\\":\\"The food was great but the wait was long\\", \\"platform\\":\\"google\\"}"`;

      $("curlSummary").textContent =
`curl "${base}/summary" \\
  -H "x-api-key: ${key}"`;
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        // Fallback for older browsers
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      }
    }

    async function loadMe(){
      showErr("");
      setPill("Loading…");
      updateCurlExamples();

      const base = getBase();
      const key = getKey();
      if (!base) return showErr("API Base URL is required.");
      if (!key) return showErr("API key is required.");

      try{
        const r = await fetch(`${base}/me`, {
          headers: { "x-api-key": key }
        });

        if (!r.ok){
          const txt = await r.text();
          setPill("Error", false);
          return showErr(`Request failed (${r.status}): ${txt}`);
        }

        const data = await r.json();

        $("biz").textContent = data.business_id || "—";
        $("email").textContent = data.email || "—";
        $("plan").textContent = data.subscription?.plan || "starter";
        $("subStatus").textContent = data.subscription?.status || "inactive";
        $("periodEnd").textContent = data.subscription?.current_period_end || "N/A";

        const ok = (data.subscription?.status === "active");
        setPill(ok ? "Connected (active)" : "Connected (inactive)", ok);

      }catch(e){
        setPill("Error", false);
        showErr(`Network error: ${e}`);
      }
    }

    function saveKey(){
      const key = getKey();
      const base = getBase();
      if (!key) return showErr("API key is required to save.");
      localStorage.setItem("ra_api_key", key);
      localStorage.setItem("ra_api_base", base);
      setPill("Saved locally", true);
      showErr("");
      updateCurlExamples();
    }

    function clearKey(){
      localStorage.removeItem("ra_api_key");
      localStorage.removeItem("ra_api_base");
      $("apiKey").value = "";
      setPill("Cleared", true);
      showErr("");
      updateCurlExamples();
    }

    // init
    (function(){
      const savedKey = localStorage.getItem("ra_api_key");
      const savedBase = localStorage.getItem("ra_api_base");
      if (savedBase) $("apiBase").value = savedBase;
      if (savedKey) $("apiKey").value = savedKey;
      updateCurlExamples();

      $("btnLoad").addEventListener("click", loadMe);
      $("btnSave").addEventListener("click", saveKey);
      $("btnClear").addEventListener("click", clearKey);

      $("apiBase").addEventListener("input", updateCurlExamples);
      $("apiKey").addEventListener("input", updateCurlExamples);
      $("btnCopyKey").addEventListener("click", async () => {
        const key = getKey();
        if (!key) return showErr("No API key to copy.");
        await copyText(key);
        setPill("API key copied", true);
      });
      
      $("btnCopyAnalyze").addEventListener("click", async () => {
        await copyText($("curlAnalyze").textContent);
        setPill("/analyze curl copied", true);
      });
      
      $("btnCopySummary").addEventListener("click", async () => {
        await copyText($("curlSummary").textContent);
        setPill("/summary curl copied", true);
      });
    })();
  </script>
</body>
</html>
