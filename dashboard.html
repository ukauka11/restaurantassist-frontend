<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RestaurantAssist • Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css">

  <style>
    .hero {
      margin-top: 18px;
      padding: 22px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      background:
        radial-gradient(1200px 420px at 10% 0%, rgba(56,189,248,0.18), transparent 55%),
        radial-gradient(900px 380px at 90% 10%, rgba(34,197,94,0.16), transparent 55%),
        #0b1224;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .hero h1{ margin:0; font-size: 34px; letter-spacing: -0.3px; color:#fff; }
    .hero .sub{ margin-top:10px; font-size:14px; color:#cbd5e1; line-height:1.6; max-width: 950px; }

    .grid { margin-top: 16px; display:grid; grid-template-columns: 1.1fr 0.9fr; gap: 16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .sectionTitle{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .sectionTitle h2{ margin:0; font-size: 18px; color:#e2e8f0; }
    .hint{ font-size: 12px; color:#94a3b8; line-height: 1.5; }

    label{ display:block; font-size: 13px; color:#94a3b8; margin: 10px 0 6px; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: #0a1020;
      color:#e5e7eb;
      outline:none;
      font-family: inherit;
    }
    textarea{ min-height: 150px; resize: vertical; }
    input:focus, select:focus, textarea:focus{ border-color: rgba(56,189,248,0.8); }

    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 900px){ .row2{ grid-template-columns: 1fr; } }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px; border-radius: 999px;
      font-weight: 800; font-size: 12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color:#cbd5e1;
    }
    .pill.ok{ border-color: rgba(34,197,94,0.35); background: rgba(34,197,94,0.10); color: #bbf7d0; }
    .pill.bad{ border-color: rgba(248,113,113,0.35); background: rgba(248,113,113,0.08); color: #fecaca; }

    .boxOut{
      margin-top: 12px;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      background: #070b16;
      color:#cbd5e1;
      line-height: 1.6;
    }
    .boxOut h3{ margin: 0 0 8px 0; color:#e2e8f0; font-size: 16px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ color:#94a3b8; font-size: 12px; }
    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(2,6,23,0.85);
      color:#e5e7eb;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      font-weight: 800;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
    }
    .toast.show{ opacity: 1; }
    code{ background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>
  <div class="container">

    <!-- NAV -->
    <div class="nav" id="siteNav">
      <div class="navTop">
        <div class="brand">
          <div class="dot"></div><span>RestaurantAssist</span>
        </div>
    
        <button class="navToggle btn" id="navToggle" aria-expanded="false" aria-controls="navLinks">
          ☰ Menu
        </button>
      </div>
    
      <div class="navlinks" id="navLinks">
        <a class="btn" href="/">Home</a>
        <a class="btn active" href="/dashboard.html">Dashboard</a>
        <a class="btn" href="/docs.html">Docs</a>
        <a class="btn" href="/support.html">Support</a>
      </div>
    </div>

    <!-- HERO -->
    <div class="hero">
      <h1>Dashboard</h1>
      <div class="sub">
        <strong>Super simple:</strong> copy a review → paste it → click <strong>Generate</strong> → copy the reply → post it.
        <div class="muted" style="margin-top:8px;">
          You’ll use your <code>x-api-key</code> (sent after checkout). We can remember it on this device if you click “Save key locally”.
        </div>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT: Generate -->
      <div class="card">
        <div class="leftMain">
          <div class="sectionTitle">
            <h2>1) Paste a review</h2>
            <div id="genPill" class="pill">Not ready</div>
          </div>
  
          <label>Customer review</label>
          <textarea id="reviewText" placeholder="Paste the customer’s review here..."></textarea>

          <div id="emptyHint" class="muted" style="margin-top:10px;">
            Paste a customer review above to generate a professional reply.
          </div>
  
          <div class="hint" style="margin-top:6px;">
            <button class="btn" id="clearReviewBtn" style="padding:6px 10px; font-size:12px;">Clear review</button>
          </div>
  
          <div class="btnRow">
            <button class="btn primary" id="generateBtn">Generate reply</button>
            <button class="btn" id="copyReplyBtn" disabled>Copy reply</button>
          </div>
  
          <!-- EMPTY STATE -->
          <div id="emptyState" class="boxOut" style="margin-top:12px;">
            <h3>What to do</h3>
            <div class="muted" style="margin-top:6px;">
              1) Paste a customer review above<br/>
              2) Click <strong>Generate reply</strong><br/>
              3) Click <strong>Copy reply</strong> and post it
            </div>
          </div>
          
          <!-- STATUS LINE (errors / tips) -->
          <div id="genMsg" class="muted" style="margin-top:10px; min-height:18px;"></div>
          
          <!-- LOADING STATE -->
          <div id="loadingState" class="boxOut" style="display:none; margin-top:12px;">
            <h3>Generating…</h3>
            <div class="muted" style="margin-top:6px;">
              Analyzing tone + urgency and writing a ready-to-post reply.
            </div>
          </div>
          
          <!-- RESULT -->
          <div id="resultBox" class="boxOut" style="display:none; margin-top:12px;">
            <h3>2) Your ready-to-post reply</h3>
            <div id="replyOut" style="white-space: pre-wrap;"></div>
            <div id="attentionLine" class="muted" style="margin-top:10px;"></div>
          </div>
        </div>
        <div class="leftFooter">
          <div class="boxOut">
            <h3>What happens next</h3>
            <ul style="margin:8px 0 0 18px; padding:0;">
              <li>Copy the reply</li>
              <li>Paste it into Google, Yelp, or Facebook</li>
              <li>You're done</li>
            </ul>
            <div class="muted" style="margin-top:8px;">
              RestaurantAssist keeps replies professional and consistent every time.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Connect + Account -->
      <div class="card">
        <div class="sectionTitle">
          <h2>Connect</h2>
          <div id="connPill" class="pill">Not connected</div>
        </div>

        <label>Your API Key (<code>x-api-key</code>)</label>
        <input id="apiKey" placeholder="cust_..." />

        <div class="btnRow">
          <button class="btn" id="loadBtn">Load my account</button>
          <button class="btn" id="saveBtn">Save key locally</button>
          <button class="btn" id="clearBtn">Clear saved key</button>
          <button class="btn" id="copyKeyBtn">Copy API key</button>
        </div>

        <div id="accountBox" class="boxOut" style="margin-top:14px;">
          <h3>Account</h3>
          <div class="muted">Business</div><div id="bizOut" class="mono">—</div>
          <div style="height:8px;"></div>
          <div class="muted">Email</div><div id="emailOut" class="mono">—</div>
          <div style="height:8px;"></div>

          <div class="row2">
            <div>
              <div class="muted">Plan</div>
              <div id="planOut" class="mono">—</div>
            </div>
            <div>
              <div class="muted">Status</div>
              <div id="statusOut" class="mono">—</div>
            </div>
          </div>

          <div style="height:8px;"></div>
          <div class="muted">Renews / ends</div><div id="renewOut" class="mono">—</div>

          <div class="hint" style="margin-top:10px;">
            If your status is <code>past_due</code> or <code>canceled</code>, protected API requests return <code>402</code>.
          </div>
        </div>

        <div class="hint" style="margin-top:12px;">
          Didn’t get your key? Check Spam and click <strong>“Not spam”</strong>.
        </div>
      </div>

    </div>

    <div class="footer">
      © <span id="yr"></span> RestaurantAssist • Questions? <a href="/support.html">Support</a>
    </div>
  </div>

  <div id="toast" class="toast">Copied!</div>

  <script>
    document.getElementById("yr").textContent = new Date().getFullYear();

    const API_BASE_DEFAULT = "https://review-assistant-api.onrender.com";
    const apiKeyEl  = document.getElementById("apiKey");
    const connPill = document.getElementById("connPill");
    const genPill  = document.getElementById("genPill");
    const toastEl = document.getElementById("toast");
    
    function toast(text="Done"){
      toastEl.textContent = text;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 900);
    }

    function baseUrl(){
      return API_BASE_DEFAULT;
    }

    function setConnPill(state, text){
      connPill.className = "pill " + (state || "");
      connPill.textContent = text;
    }
    function setGenPill(state, text){
      genPill.className = "pill " + (state || "");
      genPill.textContent = text;
    }

    function getKey(){
      return apiKeyEl.value.trim();
    }

    function detectPlatformFromText(text){
      const t = (text || "").toLowerCase();
    
      if (t.includes("yelp")) return "yelp";
      if (t.includes("facebook") || t.includes("fb")) return "facebook";
      if (t.includes("google") || t.includes("maps")) return "google";
    
      return "google"; // default
    }
    
    // Load saved key if exists
    const saved = localStorage.getItem("ra_api_key");
    if (saved) apiKeyEl.value = saved;

    // ---- Account (/me) ----
    async function loadAccount(){
      const key = getKey();
      if (!key) {
        setConnPill("bad", "Missing API key");
        return;
      }

      setConnPill("", "Loading…");

      try{
        const res = await fetch(`${baseUrl()}/me`, {
          headers: { "x-api-key": key }
        });
        const data = await res.json();

        if (!res.ok){
          setConnPill("bad", "Not connected");
          // show something helpful
          document.getElementById("statusOut").textContent = data?.detail || "Error";
          return;
        }

        setConnPill("ok", "Connected");
        document.getElementById("bizOut").textContent = data.business_id || "—";
        document.getElementById("emailOut").textContent = data.email || "—";

        const sub = data.subscription || {};
        document.getElementById("planOut").textContent = sub.plan || "starter";
        document.getElementById("statusOut").textContent = sub.status || "inactive";
        document.getElementById("renewOut").textContent = sub.current_period_end || "N/A";
      }catch(e){
        setConnPill("bad", "Network error");
      }
    }

    // ---- Generate (/analyze) ----
    const generateBtn = document.getElementById("generateBtn");
    const copyReplyBtn = document.getElementById("copyReplyBtn");
    const clearReviewBtn = document.getElementById("clearReviewBtn");
    const genMsg = document.getElementById("genMsg");
    const resultBox = document.getElementById("resultBox");
    const emptyState = document.getElementById("emptyState");
    const loadingState = document.getElementById("loadingState");
    
    function showEmpty(){
      if (emptyState) emptyState.style.display = "block";
      if (loadingState) loadingState.style.display = "none";
      resultBox.style.display = "none";
    }
    
    function showLoading(){
      if (emptyState) emptyState.style.display = "none";
      if (loadingState) loadingState.style.display = "block";
      resultBox.style.display = "none";
    }

    function setGenMsg(text){ genMsg.textContent = text || ""; }

    async function generateReply(){
      const key = getKey();
      const review_text = document.getElementById("reviewText").value.trim();
      const platform = detectPlatformFromText(review_text);

      showEmpty();
      copyReplyBtn.disabled = true;

      if (!review_text){
        setGenPill("bad", "Paste a review first");
        return setGenMsg("Paste a customer review, then click Generate.");
      }
      if (!key){
        setGenPill("bad", "Missing API key");
        return setGenMsg("Paste your API key on the right first.");
      }

      setGenPill("", "Generating…");
      setGenMsg("");
      showLoading();
      generateBtn.disabled = true;

      try{
        const res = await fetch(`${baseUrl()}/analyze`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": key
          },
          body: JSON.stringify({ review_text, platform })
        });

        const data = await res.json();

        if (!res.ok){
          setGenPill("bad", "Could not generate");
          const detail = data?.detail || "Error generating reply.";
          setGenMsg(detail);
          return;
        }

        // The backend returns something like: { business_id, record: {...} }
        const record = data.record || data;

        const reply = record.reply || record.response || "";
        const sentiment = record.sentiment || "—";
        const urgency = record.urgency || "—";
        const category = record.category || "—";
        const tags = Array.isArray(record.tags) ? record.tags.join(", ") : (record.tags || "—");
        const steps = Array.isArray(record.next_steps) ? record.next_steps : [];

        document.getElementById("replyOut").textContent = reply || "(No reply returned)";
        document.getElementById("sentimentOut").textContent = sentiment;
        document.getElementById("urgencyOut").textContent = urgency;
        document.getElementById("categoryOut").textContent = category;
        document.getElementById("tagsOut").textContent = tags;

        const attentionLine = document.getElementById("attentionLine");
        if (String(urgency).toLowerCase().includes("high")) {
          attentionLine.innerHTML = "⚠️ <strong>Needs attention:</strong> consider following up personally.";
        } else {
          attentionLine.textContent = "Looks good. Copy and post.";
        }

        const stepsOut = document.getElementById("stepsOut");
        if (steps.length){
          stepsOut.innerHTML = "<ul style='margin:0 0 0 18px; padding:0;'>" +
            steps.map(s => `<li style="margin:6px 0;">${escapeHtml(String(s))}</li>`).join("") +
            "</ul>";
        }else{
          stepsOut.innerHTML = "<span class='muted'>None</span>";
        }

        if (loadingState) loadingState.style.display = "none";
        resultBox.style.display = "block";

        document.getElementById("emptyHint").style.display = "none";
        copyReplyBtn.disabled = !reply;

        setGenPill("ok", "Ready");
        setGenMsg("Reply ready. Copy & post — you’re done.");
      }catch(e){
        setGenPill("bad", "Network error");
        setGenMsg("Network error. Please try again.");
      }
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Buttons
    document.getElementById("loadBtn").addEventListener("click", loadAccount);

    document.getElementById("saveBtn").addEventListener("click", () => {
      const key = getKey();
      if (!key) return;
      localStorage.setItem("ra_api_key", key);
      toast("Saved locally");
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      localStorage.removeItem("ra_api_key");
      apiKeyEl.value = "";
      toast("Cleared");
      setConnPill("", "Not connected");
    });

    document.getElementById("copyKeyBtn").addEventListener("click", async () => {
      const key = getKey();
      if (!key) return;
      await navigator.clipboard.writeText(key);
      toast("API key copied");
    });

    generateBtn.addEventListener("click", generateReply);

    copyReplyBtn.addEventListener("click", async () => {
      const reply = document.getElementById("replyOut").textContent || "";
      if (!reply) return;
      await navigator.clipboard.writeText(reply);
      toast("Reply copied ✓");
      setGenMsg("Done. Paste it into Google/Yelp/Facebook.");
    });

    clearReviewBtn.addEventListener("click", () => {
      document.getElementById("reviewText").value = "";
      copyReplyBtn.disabled = true;
      setGenPill("", "Not ready");
      setGenMsg("");
      showEmpty();
    });

    // On load: make it feel smart (optional)
    if (getKey()) loadAccount();
    setGenPill("", "Not ready");
    setConnPill("", getKey() ? "Connected?" : "Not connected");
    showEmpty();

    function refreshUI(){
      const hasKey = !!getKey();
      const hasReview = !!document.getElementById("reviewText").value.trim();
    
      generateBtn.disabled = !(hasKey && hasReview);
    
      if (!hasKey) setGenPill("bad", "Paste API key");
      else if (!hasReview) setGenPill("", "Paste review");
      else setGenPill("ok", "Ready");
    }
    
    apiKeyEl.addEventListener("input", refreshUI);
    document.getElementById("reviewText").addEventListener("input", refreshUI);
    refreshUI();
  </script>
  <script>
    (function(){
      const nav = document.getElementById("siteNav");
      const toggle = document.getElementById("navToggle");
      const links = document.getElementById("navLinks");
      if (!nav || !toggle || !links) return;
  
      toggle.addEventListener("click", () => {
        const isOpen = nav.classList.toggle("open");
        toggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
      });
  
      // Close menu after tapping a link (mobile)
      links.querySelectorAll("a").forEach(a => {
        a.addEventListener("click", () => {
          nav.classList.remove("open");
          toggle.setAttribute("aria-expanded", "false");
        });
      });
    })();
  </script>
</body>
</html>
