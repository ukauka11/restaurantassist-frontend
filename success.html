<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Success</title>
</head>
<body style="font-family: Arial, sans-serif; padding: 40px;">
  <h1>✅ Checkout complete</h1>
  <div style="margin-top:16px; padding:12px; border:1px solid #2ecc71; border-radius:6px; background:#0f2a1d;">
    <strong>Important:</strong><br>
    Your API key has been sent to your email.
    <br><br>
    If you don’t see it within <strong>1 minute</strong>, please check your
    <strong>Spam</strong> folder and click <strong>“Not spam”</strong>.
  </div>

  <p id="status">Checking your subscription status…</p>

  <div id="details" style="margin-top:16px;"></div>

  <p style="margin-top:24px;"><a href="/">Back to home</a></p>

  <script>
    const API_BASE = "https://review-assistant-api.onrender.com";

    function getSessionId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("session_id");
    }

    async function checkStatus() {
      const sessionId = getSessionId();
      const statusEl = document.getElementById("status");
      const detailsEl = document.getElementById("details");

      if (!sessionId) {
        statusEl.textContent = "Missing session_id. Please contact support.";
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/billing/status?session_id=${encodeURIComponent(sessionId)}`);
        const data = await res.json();

        if (!res.ok) {
          statusEl.textContent = data?.detail || "Could not check status.";
          return;
        }

        if (!data.ready) {
          statusEl.textContent = data.message || "Provisioning in progress…";
          // Auto-retry a couple times
          setTimeout(checkStatus, 3000);
          return;
        }

        const sub = data.subscription || {};
        statusEl.textContent = `✅ Subscription is ${sub.status || "unknown"}`;
        detailsEl.innerHTML = `
          <p><strong>Business:</strong> ${data.business_id}</p>
          <p><strong>Plan:</strong> ${sub.plan || "starter"}</p>
          <p><strong>Renews / ends:</strong> ${sub.current_period_end || "N/A"}</p>
        `;
      } catch (e) {
        statusEl.textContent = "Network error while checking status. Please refresh.";
      }
    }

    checkStatus();
  </script>
</body>
</html>
